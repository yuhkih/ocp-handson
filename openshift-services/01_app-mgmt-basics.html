<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>コンテナデプロイと管理 :: OpenShift Handson</title>
    <link rel="canonical" href="https://yuhkih.github.io/ocp-handson/openshift-services/01_app-mgmt-basics.html">
    <link rel="prev" href="index.html">
    <link rel="next" href="01_app-deployment.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img src="../_/img/NewRHDFullLogo_4-color_white-wordmark.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://yuhkih.github.io/ocp-handson">OpenShift Handson</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="openshift-services" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html"></a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">01. OpenShift 基礎</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="01_app-mgmt-basics.html">1. コンテナデプロイと管理</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01_app-deployment.html">2. Web コンソールの利用</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02_app-storage-basics.html">3. 永続ストレージ</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03_machinesets.html">4. ノードの動的管理</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04_infra-nodes.html">5. Infra ノードの作成</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06_template-quota-limits.html">6. Project のクオータ/制限</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07_clusterresourcequota.html">7. クラスタのクオータ設定</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">20. OpenShift Pipeline Lab</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="10-pipeline-install.html">インストール</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="11-pipelines.html">1. Pipelines -1/2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="12-add-task.html">2. Pipelines -2/2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="13-triggers.html">3. Tekton Triggers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">21. OpenShift GitOps Lab</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="20-GitOps-install.html">インストール</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="21-GitOps.html">1. OpenShift GitOps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="22-Kustomize.html">2. Kustomizeインテグレーション</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="23-Helm.html">3. Helmインテグレーション</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">51. Red Hat OpenShift Service on AWS (ROSA) Lab</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#50-rosa-info.adoc">0. はじめに</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#51-rosa-hcp-create.adoc">1. ROSA HCPクラスターの作成 [デモ]</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#52-rosa-app-deploy.adoc">2. サンプルアプリケーションのデプロイ</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#53-rosa-ebs.adoc">3. Amazon EBSの利用</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#54-1-rosa-web-terminal.adoc">4. Web Terminalの利用</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#54-2-rosa-dev-spaces.adoc">5. Web IDEを利用した開発</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#58-rosa-bedrock.adoc">6. Amazon Bedrockアプリケーションの実行</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#55-1-rosa-log-01.adoc">7. ロギング設定 [デモ]</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#55-1-rosa-log-02.adoc">8. Amazon CloudWatchでのログ確認</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#55-2-rosa-monitoring.adoc">9. モニタリング</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#55-3-rosa-project-metrics.adoc">10. プロジェクトのメトリクスデータの確認</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#55-4-rosa-alert.adoc">11. アラート設定</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#56-rosa-nodes.adoc">12. ワーカーノードの追加と削除</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#57-rosa-upgrade.adoc">13. ROSA HCPクラスターの更新</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">61. Azure Red Hat OpenShift (ARO) Lab</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="60-aro-info.html">0. はじめに</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="61-aro-create.html">1. AROクラスターの作成 [デモ]</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="62-aro-app-deploy.html">2. サンプルアプリケーションのデプロイ</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="63-aro-storage.html">3. Azure DiskとAzure Filesの利用</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="64-aro-web-terminal.html">4. Web Terminalの利用</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="65-aro-dev-spaces.html">5. Web IDEを利用した開発</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="66-aro-logging.html">6. ロギング</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="67-1-aro-monitoring.html">7. モニタリング</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="67-2-aro-project-metrics.html">8. プロジェクトのメトリクスデータの確認</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="67-3-aro-alert.html">9. アラート設定</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="68-aro-nodes.html">10. ワーカーノードの追加と削除</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="69-aro-upgrade.html">11. AROクラスターの更新[デモ]</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">OpenShift Handson</a></li>
    <li>01. OpenShift 基礎</li>
    <li><a href="01_app-mgmt-basics.html">1. コンテナデプロイと管理</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/yuhkih/ocp-handson/edit/master/documentation/modules/ROOT/pages/01_app-mgmt-basics.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">コンテナデプロイと管理</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>本コンテンツは、<a href="https://github.com/team-ohc-jp-place/openshift-cns-testdrive">MAD Workshop Ops Track</a> の内容をベースに、一部変更しています。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_演習の概要"><a class="anchor" href="#_演習の概要"></a>演習の概要</h2>
<div class="sectionbody">
<div class="paragraph">
<p>このモジュールでは、<code>oc</code> ツールを使用してサンプルアプリケーションをデプロイし、OpenShift Container Platform上でのコアとなる概念、基本オブジェクト、アプリケーション管理の基本について学習します。</p>
</div>
<hr>
<div class="sect2">
<h3 id="_openshiftのコアとなる概念"><a class="anchor" href="#_openshiftのコアとなる概念"></a>OpenShiftのコアとなる概念</h3>
<div class="paragraph">
<p>OpenShiftの管理者として、アプリケーションに関連するいくつかのコアとなるビルディングブロックを理解することは重要です。これらのビルディングブロックを理解することで、プラットフォーム上でのアプリケーション管理の全体像をよりよく理解することができます。</p>
</div>
</div>
<div class="sect2">
<h3 id="_projects"><a class="anchor" href="#_projects"></a>Projects</h3>
<div class="paragraph">
<p><strong>Project</strong> は一種の「バケツ」です。これは、すべてのユーザのリソースが存在するメタ構造です。<br>
管理の観点からは、各Projectはテナントのように考えることができます。そのためProjectにはアクセスできる複数のユーザがいるかもしれませんし、ユーザは複数のProjectにアクセスできるかもしれません。<br>
技術的に言えば、リソースはユーザが所有しているのではなく、Projectが所有しています。したがって、ユーザを削除しても作成されたリソースには影響しません。</p>
</div>
<div class="paragraph">
<p>この演習ではまず、いくつかのリソースを保持するProjectを作成します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc new-project app-management</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_サンプルアプリケーションのデプロイ"><a class="anchor" href="#_サンプルアプリケーションのデプロイ"></a>サンプルアプリケーションのデプロイ</h3>
<div class="paragraph">
<p><code>new-app</code> コマンドは、OpenShiftでアプリケーションを実行するように指示するシンプルな方法です。
ユーザはこのコマンドを使ってOpenShiftで既存のイメージを起動させたり、ソースコードをビルドしてデプロイしたり、テンプレートをインスタンス化したりするのが一般的です。<br></p>
</div>
<div class="paragraph">
<p>次のようにQuay上に存在する特定のイメージを起動します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc new-app quay.io/openshiftroadshow/mapit</code></pre>
</div>
</div>
<div class="paragraph">
<p>出力は以下のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; Found container image 7ce7ade (3 years old) from quay.io for "quay.io/openshiftroadshow/mapit"

    * An image stream tag will be created as "mapit:latest" that will track this image

--&gt; Creating resources ...
    imagestream.image.openshift.io "mapit" created
    deployment.apps "mapit" created
    service "mapit" created
--&gt; Success
    Application is not exposed. You can expose services to the outside world by executin
g one or more of the commands below:
     'oc expose service/mapit'
    Run 'oc status' to view your app.</pre>
</div>
</div>
<div class="paragraph">
<p>このコマンドの出力でOpenShiftがいくつかのリソースを自動的に作成したことがわかります。作成されたリソースを少し時間をかけて調べてみましょう。</p>
</div>
<div class="paragraph">
<p><code>new-app</code> の機能の詳細については、 <code>oc new-app -h</code> を実行して、そのヘルプメッセージを見てください。</p>
</div>
</div>
<div class="sect2">
<h3 id="_pods"><a class="anchor" href="#_pods"></a>Pods</h3>
<div class="imageblock">
<div class="content">
<img src="_images/basics/appmgmt/openshift_pod.png" alt="openshift pod">
</div>
<div class="title">Figure 1. OpenShift Pods</div>
</div>
<div class="paragraph">
<p><strong>Pod</strong> とは、ホスト上に一緒にデプロイされた1つまたは複数のコンテナのことです。PodはOpenShiftで定義、デプロイ、管理できるコンピュートリソースの最小の単位です。<br>
各PodはSDN上で独自の内部IPアドレスを割り当てられ、ポート範囲全体を所有します。また、Pod内のコンテナはローカルストレージ領域とネットワークリソースを共有できます。</p>
</div>
<div class="paragraph">
<p>PodはOpenShiftでは <strong>静的な</strong> オブジェクトとして扱われ、実行中にPodの定義を変更することはできません。</p>
</div>
<div class="paragraph">
<p>Podの一覧は次のように取得できます。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のように出力されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME                     READY   STATUS    RESTARTS   AGE
mapit-764c5bf8b8-l49z7   1/1     Running   0          2m53s</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Pod名はデプロイプロセスの一部として動的に生成されますが、これについては後ほど説明します。また表示される名前はこの表示とは少し異なります。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>oc describe</code> コマンドを使うと、Podの詳細を知ることができます。上記のPod名の場合、</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc describe pod -l deployment=mapit</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>-l deployment=mapit</code> Podは後述する <code>Deployment</code> に関連しています。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>と実行すると、以下のような出力が表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Name:         mapit-764c5bf8b8-l49z7
Namespace:    app-management
Priority:     0
Node:         ip-10-0-128-29.us-west-2.compute.internal/10.0.128.29
Start Time:   Tue, 10 Nov 2020 21:01:09 +0000
Labels:       deployment=mapit
              pod-template-hash=764c5bf8b8
Annotations:  k8s.v1.cni.cncf.io/network-status:
                [{
                    "name": "",
                    "interface": "eth0",
                    "ips": [
                        "10.129.2.99"
                    ],
                    "default": true,
                    "dns": {}
                }]
              k8s.v1.cni.cncf.io/networks-status:
                [{
                    "name": "",
                    "interface": "eth0",
                    "ips": [
                        "10.129.2.99"
                    ],
                    "default": true,
                    "dns": {}
                }]
              openshift.io/generated-by: OpenShiftNewApp
              openshift.io/scc: restricted
Status:       Running
IP:           10.129.2.99
IPs:
  IP:           10.129.2.99
Controlled By:  ReplicaSet/mapit-764c5bf8b8
Containers:
  mapit:
    Container ID:   cri-o://fb708e659c19c6aaf8211bf7e3029f8adc8cf14959bcaefa5c7e6df17d37
feaf
    Image:          quay.io/openshiftroadshow/mapit@sha256:8c7e0349b6a016e3436416f3c54debda4594ba0
9fd34b8a0dee0c4497102590d
    Image ID:       quay.io/openshiftroadshow/mapit@sha256:8c7e0349b6a016e3436416f3c54debda4594ba0
9fd34b8a0dee0c4497102590d
    Ports:          9779/TCP, 8080/TCP, 8778/TCP
    Host Ports:     0/TCP, 0/TCP, 0/TCP
    State:          Running
      Started:      Tue, 10 Nov 2020 21:01:29 +0000
    Ready:          True
    Restart Count:  0
    Environment:    &lt;none&gt;
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-v7fpq (ro)
Conditions:
  Type              Status
  Initialized       True
  Ready             True
  ContainersReady   True
  PodScheduled      True
Volumes:
  default-token-v7fpq:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  default-token-v7fpq
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  &lt;none&gt;
Tolerations:     node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                 node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason          Age    From               Message
  ----    ------          ----   ----               -------
  Normal  Scheduled       6m50s  default-scheduler  Successfully assigned app-management
/mapit-764c5bf8b8-l49z7 to ip-10-0-128-29.us-west-2.compute.internal
  Normal  AddedInterface  6m48s  multus             Add eth0 [10.129.2.99/23]
  Normal  Pulling         6m48s  kubelet            Pulling image "quay.io/openshiftroadshow/mapit
@sha256:8c7e0349b6a016e3436416f3c54debda4594ba09fd34b8a0dee0c4497102590d"
  Normal  Pulled          6m31s  kubelet            Successfully pulled image "quay.io/t
horaxe/mapit@sha256:8c7e0349b6a016e3436416f3c54debda4594ba09fd34b8a0dee0c4497102590d" in
 16.762028989s
  Normal  Created         6m31s  kubelet            Created container mapit
  Normal  Started         6m31s  kubelet            Started container mapit</pre>
</div>
</div>
<div class="paragraph">
<p>これは、実行しているPodの詳細な説明です。Podがどのノードで動いているか、Podの内部IPアドレス、各種ラベル、その他何が起こっているかについての情報を見ることができます。</p>
</div>
</div>
<div class="sect2">
<h3 id="_services"><a class="anchor" href="#_services"></a>Services</h3>
<div class="imageblock">
<div class="content">
<img src="_images/basics/appmgmt/openshift_service.png" alt="openshift service">
</div>
<div class="title">Figure 2. OpenShift Service</div>
</div>
<div class="paragraph">
<p><strong>Services</strong> はOpenShift内部でPodのようなグループを見つけるのに便利な抽象化レイヤーを提供します。<br>
<strong>Service</strong> はまた、それらのPodと、OpenShift環境内からPodにアクセスする必要のある他の何かとの間の内部プロキシ/ロードバランサーとしても機能します。<br>
例えば、負荷を処理するためにより多くの <code>mapit</code> インスタンスが必要な場合、より多くのPodを立ち上げることができますが、OpenShiftは自動的にそれらのPodを <strong>Service</strong> へのエンドポイントとしてマップします。これによってアプリケーションへのリクエストはこれまでと変わらず処理され、<strong>Service</strong> がリクエストをより適切に処理するようになったことを除いて、リクエストは何も変わりません。</p>
</div>
<div class="paragraph">
<p>OpenShiftにイメージを実行するよう依頼することで、<code>new-app</code> コマンドが自動的に <strong>Service</strong> を作成しました。<br>
ここで覚えていただきたいことは、<strong>Service</strong> はOpenShift内部のためのものであるということです。「外の世界」から利用することはできません。これについてはあとで学習します。</p>
</div>
<div class="paragraph">
<p><strong>Service</strong> が一連のPodにマップされる方法は、<strong>Labels</strong> と <strong>Selectors</strong> を介して行われます。<br>
<strong>Services</strong> には固定IPアドレスが割り当てられ、多くのポートやプロトコルをマッピングすることができます。</p>
</div>
<div class="paragraph">
<p>手作業で作成するためのYAML形式など、
<a href="https://docs.openshift.com/container-platform/4.9/architecture/understanding-development.html#understanding-kubernetes-pods">Services</a>
については公式ドキュメントに多くの情報があります。</p>
</div>
<div class="paragraph">
<p>それではProject内の <strong>Service</strong> のリストを見てみましょう。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get services</code></pre>
</div>
</div>
<div class="paragraph">
<p>下記のように表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
mapit   ClusterIP   172.30.167.160   &lt;none&gt;        8080/TCP,8778/TCP,9779/TCP   26</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<strong>Service</strong> のIPアドレスは作成時に動的に割り当てられますが、これは変わることはありません。<strong>Service</strong> のIPアドレスは <strong>Service</strong> が削除されるまで予約されます。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Pod</strong> と同じように、<strong>Service</strong> も <code>describe</code> で説明を表示することができます。OpenShiftではほとんどのオブジェクトを <code>describe</code> で説明を表示することができます。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc describe service mapit</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のように表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Name:              mapit
Namespace:         app-management
Labels:            app=mapit
                   app.kubernetes.io/component=mapit
                   app.kubernetes.io/instance=mapit
Annotations:       openshift.io/generated-by: OpenShiftNewApp
Selector:          deployment=mapit
Type:              ClusterIP
IP:                172.30.167.160
Port:              8080-tcp  8080/TCP
TargetPort:        8080/TCP
Endpoints:         10.129.2.99:8080
Port:              8778-tcp  8778/TCP
TargetPort:        8778/TCP
Endpoints:         10.129.2.99:8778
Port:              9779-tcp  9779/TCP
TargetPort:        9779/TCP
Endpoints:         10.129.2.99:9779
Session Affinity:  None
Events:            &lt;none&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>すべてのオブジェクトに関する情報(それらの定義、オブジェクトの状態など)は、etcdデータストアに格納されます。<br>
etcdはデータをKeyとValueのペアとして格納し、このデータはすべてシリアライズ可能なデータオブジェクト（JSON、YAML）として表すことができます。</p>
</div>
<div class="paragraph">
<p><strong>Service</strong> のYAML出力を見てみましょう。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get service mapit -o yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のように表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>apiVersion: v1
kind: Service
metadata:
  annotations:
    openshift.io/generated-by: OpenShiftNewApp
  creationTimestamp: "2020-11-10T21:01:09Z"
  labels:
    app: mapit
    app.kubernetes.io/component: mapit
    app.kubernetes.io/instance: mapit
  managedFields:
  - apiVersion: v1
    fieldsType: FieldsV1
    fieldsV1:
      f:metadata:
        f:annotations:
          .: {}
          f:openshift.io/generated-by: {}
        f:labels:
          .: {}
          f:app: {}
          f:app.kubernetes.io/component: {}
          f:app.kubernetes.io/instance: {}
      f:spec:
        f:ports:
          .: {}
          k:{"port":8080,"protocol":"TCP"}:
            .: {}
            f:name: {}
            f:port: {}
            f:protocol: {}
            f:targetPort: {}
          k:{"port":8778,"protocol":"TCP"}:
            .: {}
            f:name: {}
            f:port: {}
            f:protocol: {}
            f:targetPort: {}
          k:{"port":9779,"protocol":"TCP"}:
            .: {}
            f:name: {}
            f:port: {}
            f:protocol: {}
            f:targetPort: {}
        f:selector:
          .: {}
          f:deployment: {}
        f:sessionAffinity: {}
        f:type: {}
    manager: oc
    operation: Update
    time: "2020-11-10T21:01:09Z"
  name: mapit
  namespace: app-management
  resourceVersion: "106194"
  selfLink: /api/v1/namespaces/app-management/services/mapit
  uid: 921c2e2c-a53e-4f83-8e76-9df962069314
spec:
  clusterIP: 172.30.167.160
  ports:
  - name: 8080-tcp
    port: 8080
    protocol: TCP
    targetPort: 8080
  - name: 8778-tcp
    port: 8778
    protocol: TCP
    targetPort: 8778
  - name: 9779-tcp
    port: 9779
    protocol: TCP
    targetPort: 9779
  selector:
    deployment: mapit
  sessionAffinity: None
  type: ClusterIP
status:
  loadBalancer: {}</pre>
</div>
</div>
<div class="paragraph">
<p>ここで <code>selector</code> に注目し、これを覚えておきましょう。</p>
</div>
<div class="paragraph">
<p>同様に <strong>Pod</strong> のYAMLも調べてみて、OpenShiftがコンポーネント同士を繋げている様子を理解するのも面白いことです。<br>
<code>mapit</code> Podの名前を探して、以下を実行します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get pod -l deployment=mapit -o jsonpath='{.items[*].metadata.labels}' | jq -r</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>-o jsonpath</code> は特定のフィールドを選択します。このケースではマニフェストの <code>labels</code> セクションを尋ねています。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>以下のように表示されているはずです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
  "deployment": "mapit",
  "pod-template-hash": "764c5bf8b8"
}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Service</strong> には <code>deployment: mapit</code> を参照する <code>selector</code> があります。</p>
</li>
<li>
<p><strong>Pod</strong> には複数の <strong>Label</strong> があります。</p>
<div class="ulist">
<ul>
<li>
<p><code>deployment: mapit</code></p>
</li>
<li>
<p><code>pod-template-hash: 764c5bf8b8</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Labels</strong> は単なるkey/valueのペアです。この <strong>Project</strong> 内で <strong>Selector</strong> に一致する <strong>Label</strong> を持つ <strong>Pod</strong> はすべて、 <strong>Service</strong> 関連付けられます。<br>
もう一度 <code>oc describe</code> の出力を見てみると、<strong>Service</strong> のエンドポイントが1つあることが分かります。これはつまり、既存の <code>mapit</code> <strong>Pod</strong> であることがわかります。</p>
</div>
<div class="paragraph">
<p><code>new-app</code> のデフォルトの動作は、リクエストされたアイテムのインスタンスを1つだけ作成することです。これを修正/調整する方法を見ていきますが、その前にいくつかの概念を学んでおきましょう。</p>
</div>
</div>
<div class="sect2">
<h3 id="_deployment_と_replica_sets"><a class="anchor" href="#_deployment_と_replica_sets"></a>Deployment と Replica Sets</h3>
<div class="paragraph">
<p><strong>Service</strong> が <strong>Pod</strong> のルーティングとロードバランシングを提供するのに対し、 <strong>ReplicaSets (RS)</strong> は、必要な数の <strong>Pod</strong>(=レプリカ) を確実に存在させるために使用されます。<br>
例えば、アプリケーションを常に3つの <strong>Pod</strong> にスケールさせておきたい場合は、<strong>ReplicaSet</strong> が必要になります。<strong>ReplicaSet</strong> がないと、何らかの理由で停止・終了した <strong>Pod</strong> は自動的に再作成されません。<strong>ReplicaSet</strong> はOpenShiftが「自己修復」する方法を提供します。</p>
</div>
<div class="paragraph">
<p><strong>Deployment</strong> (deploy) はOpenShift内の何かをどのようにデプロイするかを定義します。以下は <a href="https://docs.openshift.com/container-platform/4.9/applications/deployments/what-deployments-are.html#deployments-kube-deployments_what-deployments-are" target="_blank" rel="noopener">deployments documentation</a> の抜粋です。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Deployments describe the desired state of a particular component of an
application as a Pod template. Deployments create ReplicaSets, which
orchestrate Pod lifecycles.</pre>
</div>
</div>
<div class="paragraph">
<p>ほとんどの場合、<strong>Pod</strong> , <strong>Service</strong> , <strong>ReplicaSet</strong> , <strong>Deployment</strong> のリソースを一緒に使用することになります。そして、ほとんどの場合、OpenShiftがすべてのリソースを作成してくれます。</p>
</div>
<div class="paragraph">
<p><strong>Deployment</strong> や <strong>Service</strong> を必要としない <strong>Pod</strong> や <strong>RS</strong> が求められるエッジケースもありますが、これらはこの演習では説明しない高度なトピックです。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
以前のOpenShiftのバージョンでは <strong>DeploymentConfig</strong> と呼ばれるものが使用されていました。まだ有効なメカニズムですが、<strong>Deployment</strong> に移行しており、<code>oc new-app</code> コマンドによって何が作成されるのかは
<a href="https://docs.openshift.com/container-platform/4.9/applications/deployments/what-deployments-are.html#deployments-comparing-deploymentconfigs_what-deployments-are">official
documentation</a> を参照してください。
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_deploymentに関連するオブジェクトの探索"><a class="anchor" href="#_deploymentに関連するオブジェクトの探索"></a>Deploymentに関連するオブジェクトの探索</h3>
<div class="paragraph">
<p><strong>ReplicaSet</strong> と <strong>Deployment</strong> が何かが分かったので、それらがどのように動作し、どのように関連しているかを探ってみましょう。<br>
OpenShiftに <code>mapit</code> イメージを立ち上げるように指示したときに作成された <strong>Deployment</strong> (deploy)を見てみましょう。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のように表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME    READY   UP-TO-DATE   AVAILABLE   AGE
mapit   1/1     1            1           76m</pre>
</div>
</div>
<div class="paragraph">
<p>より詳しく知るために、<strong>ReplicaSet (RS)</strong> について調べることができます。</p>
</div>
<div class="paragraph">
<p>OpenShiftに <code>mapit</code> イメージを立ち上げるように指示したときに作成された <strong>ReplicaSet (RS)</strong> を見てみましょう。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get rs</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のように表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME               DESIRED   CURRENT   READY   AGE
mapit-764c5bf8b8   1         1         1       77m</pre>
</div>
</div>
<div class="paragraph">
<p>これより、1つの <strong>Pod</strong> がデプロイされることが希望され (Desired)、実際にデプロイされた <strong>Pod</strong> が1つあることがわかります (Current)。希望する <strong>Pod</strong> の数を変更することで、OpenShiftに <strong>Pod</strong> の数を増やしたいか減らしたいかを伝えることができます。</p>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションのスケーリング"><a class="anchor" href="#_アプリケーションのスケーリング"></a>アプリケーションのスケーリング</h3>
<div class="paragraph">
<p><code>mapit</code> アプリケーションを2つのインスタンスまでスケールしてみましょう。これは scale コマンドで行うことができます。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc scale --replicas=2 deploy/mapit</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のコマンドでレプリカの数が変更されたことを確認できます。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get rs</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のように表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME               DESIRED   CURRENT   READY   AGE
mapit-764c5bf8b8   2         2         2       79m
mapit-8695cb9c67   0         0         0       79m</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
古いバージョンのものが保持されています。これにより、アプリケーションを以前のバージョンに "rollback"することができます。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>これで 2つのレプリカができたことがわかります。<code>oc get pods</code> コマンドでPodの数を確認してみましょう。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のように表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME                     READY   STATUS    RESTARTS   AGE
mapit-764c5bf8b8-b4vpn   1/1     Running   0          112s
mapit-764c5bf8b8-l49z7   1/1     Running   0          81m</pre>
</div>
</div>
<div class="paragraph">
<p>そして最後に、<strong>Service</strong> が2つのエンドポイントを正しく反映しているかを検証してみましょう。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc describe svc mapit</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のように表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Name:              mapit
Namespace:         app-management
Labels:            app=mapit
                   app.kubernetes.io/component=mapit
                   app.kubernetes.io/instance=mapit
Annotations:       openshift.io/generated-by: OpenShiftNewApp
Selector:          deployment=mapit
Type:              ClusterIP
IP:                172.30.167.160
Port:              8080-tcp  8080/TCP
TargetPort:        8080/TCP
Endpoints:         10.128.2.19:8080,10.129.2.99:8080
Port:              8778-tcp  8778/TCP
TargetPort:        8778/TCP
Endpoints:         10.128.2.19:8778,10.129.2.99:8778
Port:              9779-tcp  9779/TCP
TargetPort:        9779/TCP
Endpoints:         10.128.2.19:9779,10.129.2.99:9779
Session Affinity:  None
Events:            &lt;none&gt;</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Service</strong> のエンドポイントを見る別の方法としては、次のようなものがあります。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get endpoints mapit</code></pre>
</div>
</div>
<div class="paragraph">
<p>すると、以下のように表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME    ENDPOINTS                                                        AGE
mapit   10.128.2.19:8080,10.129.2.99:8080,10.128.2.19:9779 + 3 more...   81m</pre>
</div>
</div>
<div class="paragraph">
<p>各 <strong>Pod</strong> はOpenShift環境内で一意のIPアドレスを受信するため、IPアドレスは異なる可能性があります。エンドポイントのリストは、Serviceの背後にあるPodの数を確認する簡単な方法です。</p>
</div>
<div class="paragraph">
<p>全体的に見ると、アプリケーション(<strong>Service</strong> 内の <strong>Pod</strong>)をスケーリングすることはこのように簡単なことがわかります。<br>
OpenShiftは既存のイメージの新しいインスタンスを起動しているだけなので、特にそのイメージがすでにノードにキャッシュされている場合は、アプリケーションのスケーリングは非常に早く行われることがあります。</p>
</div>
<div class="paragraph">
<p>最後に注意すべきことは、この <strong>Service</strong> には実際にいくつかのポートが定義されているということです。<br>
先ほど、1つの <strong>Pod</strong> が1つのIPアドレスを取得し、そのIPアドレス上のポート空間全体を制御すると述べました。<strong>Pod</strong> 内で実行されている何かが複数のポートをリッスンすることがありますが(単一のコンテナが複数のポートを使用しているケース、個別のコンテナが個別のポートを使用しているケース、それらが混在しているケース、など)、<strong>Service</strong> は実際にはポートを異なる場所にプロキシ/マッピングすることができます。</p>
</div>
<div class="paragraph">
<p>例えば、<strong>Service</strong> は(レガシーな理由で)80番ポートをリッスンすることができますが、<strong>Pod</strong> は8080や8888などの他のポートをリッスンしている可能性があります。</p>
</div>
<div class="paragraph">
<p>この <code>mapit</code> の場合、私たちが実行したイメージは <code>Dockerfile</code> にいくつかの <code>EXPOSE</code> 文を持っていたので、OpenShiftは自動的に <strong>Service</strong> 上にポートを作成し、それらを <strong>Pod</strong> にマッピングしました。</p>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションの_セルフヒーリング"><a class="anchor" href="#_アプリケーションの_セルフヒーリング"></a>アプリケーションの 「セルフヒーリング」</h3>
<div class="paragraph">
<p>OpenShiftの <strong>RS</strong> は、希望する数の <strong>Pod</strong> が実際に動いているかどうかを常に監視しています。そのため、何か正しくないことがあればOpenShiftが「修正」することも期待できます。</p>
</div>
<div class="paragraph">
<p>現在2つの <strong>Pod</strong> が稼働しているので、1つを「誤って」killしてしまった場合にどうなるか見てみましょう。<code>oc get pods</code> コマンドをもう一度実行して、<strong>Pod</strong> 名を選択し、次のようにしてみます。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>すると、以下のように表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME                     READY   STATUS    RESTARTS   AGE
mapit-764c5bf8b8-lxnvw   1/1     Running   0          2m28s
mapit-764c5bf8b8-rscss   1/1     Running   0          2m54s</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Deployment</strong> <code>mapit</code> に属するPodを削除します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc delete pods -l deployment=mapit --wait=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>再度 <code>oc get pods</code> コマンドを実行します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get pods</code></pre>
</div>
</div>
<div class="paragraph">
<p>何か気づきましたか? そうです、もう新しいコンテナが作成されています。</p>
</div>
<div class="paragraph">
<p>また、<strong>Pod</strong> の名前が変わっています。これは、OpenShiftが現在の状態が(削除したので <strong>Pod</strong> が0)、希望の状態(<strong>Pod</strong> が2)と一致していないことを即座に検出し、<strong>Pod</strong> をスケジューリングして修正したためです。</p>
</div>
</div>
<div class="sect2">
<h3 id="_routes"><a class="anchor" href="#_routes"></a>Routes</h3>
<div class="imageblock">
<div class="content">
<img src="_images/basics/appmgmt/openshift_route.png" alt="openshift route">
</div>
<div class="title">Figure 3. OpenShift Route</div>
</div>
<div class="paragraph">
<p><strong>Service</strong> はOpenShift内で内部の抽象化と負荷分散を提供しますが、OpenShift<strong>外</strong>のクライアント(ユーザ、システム、デバイスなど)がアプリケーションにアクセスする必要がある場合もあります。<br>
外部クライアントがOpenShift内で実行されているアプリケーションにアクセスする方法は、OpenShiftのルーティングレイヤーを介して行われます。そしてその背後にあるオブジェクトが <strong>Route</strong> です。</p>
</div>
<div class="paragraph">
<p>デフォルトのOpenShift Router(HAProxy)は、着信リクエストのHTTPヘッダを使用して、どこにプロキシするかを決定します。<br>
<strong>Service</strong>(ひいては <strong>Pod</strong>)に外部からアクセスできるようにしたい場合は、<strong>Route</strong> を作成する必要があります。オプションで <strong>Route</strong> に対してTLSなどのセキュリティを定義することができます。</p>
</div>
<div class="paragraph">
<p>Routerの設定を覚えていますか？おそらく覚えていないと思います。それは、OpenShiftのインストール中にRouter用のOperatorがデプロイされ、OperatorがRouterを作成したからです。<br>
Routerは <code>openshift-ingress</code> <strong>Project</strong> にあり、以下のコマンドでその情報を見ることができます。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc describe deployment router-default -n openshift-ingress</code></pre>
</div>
</div>
<div class="paragraph">
<p>RouterのOperatorについては、後続の演習で詳しく説明します。</p>
</div>
</div>
<div class="sect2">
<h3 id="_route_の作成"><a class="anchor" href="#_route_の作成"></a>Route の作成</h3>
<div class="paragraph">
<p><strong>Route</strong> の作成は非常に簡単なプロセスです。コマンドラインから <strong>Service</strong> を <code>exporse</code> するだけです。<br>
先ほどの <strong>Service</strong> の名前は <code>mapit</code> となっています。<strong>Service</strong> 名があれば、<strong>Route</strong> の作成はコマンド1つで簡単にできます。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc expose service mapit</code></pre>
</div>
</div>
<div class="paragraph">
<p>このように表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>route.route.openshift.io/mapit exposed</pre>
</div>
</div>
<div class="paragraph">
<p>次のコマンドで <strong>Route</strong> が作成されたことを確認します。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get route</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のように表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME    HOST/PORT                                             PATH   SERVICES   PORT       TERMINATION   WILDCARD
mapit   mapit-app-management.{{ ROUTE_SUBDOMAIN }}                   mapit      8080-tcp                 None</pre>
</div>
</div>
<div class="paragraph">
<p><code>HOST/PORT</code> 列を見ると、見慣れたFQDNが表示されています。OpenShiftはデフォルトで、定型的なホスト名で <strong>Service</strong> を <code>expose</code> します。</p>
</div>
<div class="paragraph">
<p><code>{SERVICENAME}-{PROJECTNAME}.{ROUTINGSUBDOMAIN}</code></p>
</div>
<div class="paragraph">
<p>後段のRouter Operatorラボでは、この設定とその他の設定オプションを探ります。</p>
</div>
<div class="paragraph">
<p>Routerの構成では、Routerがリッスンするドメインを指定しますが、まず最初にRouterにこれらのドメインに対するリクエストを取得する必要があります<br>
Routerが存在するホストに <code>*.apps...</code> を指すワイルドカードDNSエントリがあります。OpenShiftは <strong>Service</strong> 名、<strong>Project</strong> 名、そしてルーティングサブドメインを連結してこのFQDN/URLを作成します。</p>
</div>
<div class="paragraph">
<p>このURLにはブラウザや <code>curl</code> などのツールを使ってアクセスできます。インターネット上のどこからでもアクセスできるようにしてください。</p>
</div>
<div class="paragraph">
<p><strong>Route</strong> は <strong>Service</strong> に関連付けられており、Routerは自動的に <strong>Pod</strong> に直接接続をプロキシします。Router自体は <strong>Pod</strong> として動作し、は「本当の」インターネットとSDNの橋渡しをします。</p>
</div>
<div class="paragraph">
<p>これまでに行ったことを見返してみると、3つのコマンドでアプリケーションをデプロイし、スケールし、外部の世界からアクセスできるようにしました。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>oc new-app quay.io/thoraxe/mapit
oc scale --replicas=2 deploy/mapit
oc expose service mapit</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_スケールダウン"><a class="anchor" href="#_スケールダウン"></a>スケールダウン</h3>
<div class="paragraph">
<p>続ける前に、アプリケーションを1つのインスタンスにスケールダウンしてください。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc scale --replicas=1 deploy/mapit</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションのprobe"><a class="anchor" href="#_アプリケーションのprobe"></a>アプリケーションのProbe</h3>
<div class="paragraph">
<p>OpenShiftでは、アプリケーションインスタンスの活性度(liveness)や準備状態(readiness)をチェックするための初歩的な機能が提供されています。基本的なチェックでは不十分な場合は <strong>Pod</strong> およびコンテナ内でコマンドを実行してアプリケーションの死活をチェックすることも可能です。そのコマンドは、コンテナイメージ内に既にインストールされている任意の言語を使用した複雑なスクリプトであるかもしれません。<br></p>
</div>
<div class="paragraph">
<p>定義できるアプリケーションProbeには2種類あります。</p>
</div>
<div class="paragraph">
<p><strong>Liveness Probe</strong></p>
</div>
<div class="paragraph">
<p>Liveness Probeは、設定されているコンテナが実行されているかどうかをチェックします。Liveness Probeが失敗した場合、コンテナはkillされ再起動ポリシーが適用されます</p>
</div>
<div class="paragraph">
<p><strong>Readiness Probe</strong></p>
</div>
<div class="paragraph">
<p>Readiness Probeは、コンテナがリクエストをサービスする準備ができているかどうかを判断します。Readiness Probeが失敗した場合、エンドポイントのコントローラは、コンテナのIPアドレスをマッチするはずのすべての <strong>Service</strong> のエンドポイントから削除します。Readiness Probeは、コンテナが実行中であっても、トラフィックを受信すべきではないことをエンドポイントのコントローラに知らせるために使用することができます。</p>
</div>
<div class="paragraph">
<p>アプリケーションのProbeに関する詳細は、ドキュメントの
<a href="https://docs.openshift.com/container-platform/4.9/applications/application-health.html">Application
Health</a> セクションを参照してください。</p>
</div>
</div>
<div class="sect2">
<h3 id="_アプリケーションへのprobeの追加"><a class="anchor" href="#_アプリケーションへのprobeの追加"></a>アプリケーションへのProbeの追加</h3>
<div class="paragraph">
<p><code>oc set</code> コマンドは、いくつかの異なる機能を実行するために使用することができますが、そのうちの1つにProbeの作成/編集があります。<br>
<code>mapit</code> アプリケーションはエンドポイントを公開していますので、それが生きていて応答する準備ができているかどうかを確認することができます。
次のように <code>curl</code> を使ってテストすることが可能です。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">curl mapit-app-management.{{ ROUTE_SUBDOMAIN }}/health</code></pre>
</div>
</div>
<div class="paragraph">
<p>いくつかのJSONが得られます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{"status":"UP","diskSpace":{"status":"UP","total":10724835328,"free":10257825792,"threshold":10485760}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のコマンドを使用して、OpenShiftにこのエンドポイントが生きているかどうかを調べるように依頼することができます。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc set probe deploy/mapit --liveness --get-url=http://:8080/health --initial-delay-seconds=30</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>oc describe</code> の出力からこのProbeが定義されていることがわかります。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc describe deploy mapit</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のようなセクションが表示されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>...
  Containers:
   mapit:
    Image:        quay.io/openshiftroadshow/mapit@sha256:8c7e0349b6a016e3436416f3c54debda
4594ba09fd34b8a0dee0c4497102590d
    Ports:        9779/TCP, 8080/TCP, 8778/TCP
    Host Ports:   0/TCP, 0/TCP, 0/TCP
    Liveness:     http-get http://:8080/health delay=30s timeout=1s period=10s
#success=1 #failure=3
    Environment:  &lt;none&gt;
    Mounts:       &lt;none&gt;
  Volumes:        &lt;none&gt;
...</pre>
</div>
</div>
<div class="paragraph">
<p>Readiness Probeも同様にできます。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc set probe deploy/mapit --readiness --get-url=http://:8080/health --initial-delay-seconds=30</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deployment_と_replicasets_のテスト"><a class="anchor" href="#_deployment_と_replicasets_のテスト"></a>Deployment と ReplicaSets のテスト</h3>
<div class="paragraph">
<p><strong>Deployment</strong> への各変更は、構成変更としてカウントされ、新しいデプロイメントのトリガーとなります。</p>
</div>
<div class="paragraph">
<p>次を実行して下さい。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get deployments</code></pre>
</div>
</div>
<div class="paragraph">
<p>以下のように表示されるはずです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME    READY   UP-TO-DATE   AVAILABLE   AGE
mapit   1/1     1            1           131m</pre>
</div>
</div>
<div class="paragraph">
<p>最初のdeploymentの後に2つの構成変更を行ったため、<strong>Deployment</strong> の4番目のリビジョンになっています。</p>
</div>
<div class="paragraph">
<p>以下を実行して下さい。</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sh hljs" data-lang="sh">oc get replicasets</code></pre>
</div>
</div>
<div class="paragraph">
<p>次のように表示されるはずです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>NAME               DESIRED   CURRENT   READY   AGE
mapit-5f695ff4b8   1         1         1       4m19s
mapit-668f69cdd5   0         0         0       6m18s
mapit-764c5bf8b8   0         0         0       133m
mapit-8695cb9c67   0         0         0       133m</pre>
</div>
</div>
<div class="paragraph">
<p>新しいdeploymentがトリガーされるたびに、新しい <strong>ReplicaSet</strong> が作成されます。<br>
<strong>ReplicaSet</strong> は <strong>Pod</strong> が存在することを保証する責任を持ちます。古い <strong>RS</strong> のスケールは0で、最新の <strong>RS</strong> のスケールは1であることに注意してください。</p>
</div>
<div class="paragraph">
<p>これらの <strong>RS</strong> を、それぞれ <code>oc describe</code> すると、以前のバージョンにはProbeがなく、最新の実行中の <strong>RS</strong> にはそれぞれ新しいProbeがあることがわかります。</p>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="index.html">OpenShift Handson</a></span>
  <span class="next"><a href="01_app-deployment.html">2. Web コンソールの利用</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
